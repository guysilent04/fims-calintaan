<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Office of the Municipal Agriculture | Calintaan Farmers Information Management System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --primary-green: #2d5a27;
            --light-green: #eaf2e9;
            --accent-gold: #f4b400;
            --text-dark: #333;
            --white: #ffffff;
            --da-green: #2d6a4f;
            --da-light-green: #40916c;
            --da-yellow: #ffca3a;
            --gov-blue: #1d3557;
            --bg: #f8f9fa;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(rgba(244, 247, 244, 0.85), rgba(244, 247, 244, 0.85)), 
                        url('https://images.unsplash.com/photo-1500382017468-9049fed747ef?q=80&w=2000');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            margin: 0;
            padding: 0;
            display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow-x: hidden;
        }

        header {
            background-color: var(--primary-green);
            color: white;
            width: 100%;
            padding: 1.5rem 0;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            border-bottom: 4px solid var(--accent-gold);
            position: relative;
        }

        .header-title-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        #logo-emoji {
            font-size: 2.5rem;
            filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.3));
        }

        header h1 { margin: 0; font-size: 1.5rem; letter-spacing: 1px; text-transform: uppercase; padding: 0 10px; }
        header p { margin: 5px 0 0; opacity: 0.9; font-size: 0.8rem; font-weight: bold; text-transform: uppercase; padding: 0 10px; }

        .analytics-group { width: 95%; max-width: 1200px; margin-top: 20px; display: flex; flex-direction: column; gap: 15px; }
        .season-label { font-weight: bold; color: var(--primary-green); text-transform: uppercase; font-size: 0.8rem; text-align: left; border-left: 4px solid var(--accent-gold); padding-left: 10px; }
        
        .analytics-bar {
            display: flex;
            justify-content: center; gap: 15px; width: 100%; flex-wrap: wrap;
        }
        .stat-card {
            background: white;
            padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-bottom: 4px solid var(--primary-green); flex: 1; min-width: 150px; text-align: center;
        }
        .stat-card h4 { margin: 0; font-size: 0.7rem; color: #666; text-transform: uppercase; }
        .stat-card p { margin: 5px 0 0; font-size: 1.2rem; font-weight: bold; color: var(--primary-green); }

        .container { max-width: 1600px; width: 95%; margin-top: 20px; text-align: center; box-sizing: border-box; }

        .back-nav-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--accent-gold);
            color: var(--text-dark);
            padding: 15px 20px;
            border-radius: 50px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer;
            z-index: 999;
            display: none;
            border: none;
        }

        .contact-footer-info { max-width: 800px; margin: 20px auto 40px auto; text-align: left; font-size: 0.85rem; color: var(--primary-green); font-family: monospace; width: 90%; }
        .contact-row { display: flex; justify-content: space-between; margin-top: 5px; }
        .dashboard-search-container { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin: 20px auto; max-width: 800px; border: 2px solid var(--accent-gold); width: 90%; }
        .dash-search-box { width: 90%; padding: 10px; border: 1px solid #ccc; border-radius: 25px; font-size: 1rem; outline: none; }
        .search-results-overlay { margin-top: 15px; max-height: 200px; overflow-y: auto; text-align: left; border-radius: 8px; }
        .search-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s; display: flex; justify-content: space-between; font-size: 0.9rem; align-items: center; }
        .search-item:hover { background: var(--light-green); }
        .search-item span { font-weight: bold; color: var(--primary-green); }
        .search-item small { color: #666; font-style: italic; }

        .menu-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 30px; margin-bottom: 20px; width: 100%; }
        .card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px); border-radius: 15px; padding: 20px; cursor: pointer; transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1); position: relative; border: 1px solid #ddd; display: flex; flex-direction: column; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); min-height: 100px; justify-content: center; }
        .preview-img { width: 100%; height: 0; object-fit: cover; border-radius: 10px; opacity: 0; transition: all 0.4s ease; }
        .card:hover { transform: translateY(-5px); background-color: var(--primary-green); border-color: var(--primary-green); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .card:hover h3 { color: white; }
        .card:hover .preview-img { height: 120px; opacity: 1; margin-bottom: 15px; }
        .card h3 { margin: 10px 0; color: var(--primary-green); font-size: 1.1rem; transition: color 0.3s; }
        .card .badge { background: var(--accent-gold); color: var(--text-dark); padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; }

        .calendar-container { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin: 20px auto; max-width: 800px; width: 90%; border: 2px solid var(--primary-green); text-align: left; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; color: var(--primary-green); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .calendar-day-head { font-weight: bold; font-size: 0.8rem; color: #666; padding: 5px; }
        .calendar-day { border: 1px solid #eee; padding: 10px 5px; min-height: 60px; font-size: 0.9rem; cursor: pointer; border-radius: 5px; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; }
        .calendar-day:hover { background: var(--light-green); }
        .calendar-day.today { background: var(--accent-gold); color: white; font-weight: bold; }
        .calendar-day .pin-icon { font-size: 0.7rem; margin-top: 5px; }
        .activity-note-area { margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd; }
        #calendarNote { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; height: 80px; box-sizing: border-box; margin-bottom: 10px; }

        .hidden-calendar { display: none !important; }

        .section-view { display: none; background: white; padding: 15px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; animation: fadeIn 0.5s ease; box-sizing: border-box; text-align: left; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .home-btn { background-color: var(--accent-gold); color: var(--text-dark); padding: 10px 20px; border: none; border-radius: 30px; font-weight: bold; cursor: pointer; font-size: 0.9rem; margin-bottom: 15px; }

        .gov-header { text-align: center; margin-bottom: 20px; border-bottom: 4px solid var(--da-green); padding-bottom: 15px; }
        .gov-header h2 { margin: 0; font-size: 0.7rem; color: #555; text-transform: uppercase; }
        .gov-header h1 { color: var(--da-green); margin: 5px 0; font-size: 1.4rem; font-weight: 800; text-transform: uppercase; }
        .gov-header p { margin: 0; font-style: italic; color: var(--accent-gold); font-weight: bold; font-size: 0.8rem; }
        
        .fims-container { background: white; padding: 5px; border-radius: 4px; }
        .storage-monitor { font-size: 0.65rem; color: #666; margin-bottom: 10px; text-align: right; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; background: #fff; padding: 15px; border-radius: 4px; margin-bottom: 20px; border-left: 5px solid var(--da-yellow); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .field { display: flex; flex-direction: column; }
        .field label { font-weight: bold; font-size: 0.65rem; margin-bottom: 4px; color: var(--da-green); text-transform: uppercase; }
        .field input, .field select { padding: 8px; border: 1px solid #ccc; border-radius: 3px; font-size: 0.8rem; width: 100%; box-sizing: border-box; }
        
        .controls { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; padding: 10px; background: #f1f3f5; border-radius: 4px; align-items: center; }
        .controls button { padding: 8px 12px; cursor: pointer; font-weight: bold; text-transform: uppercase; font-size: 0.7rem; border-radius: 3px; border: none; flex-grow: 1; min-width: 120px; }
        .btn-save { background: var(--da-green); color: white; }
        .btn-sort { background: #0077b6; color: white; }
        .btn-reset { background: #6c757d; color: white; }
        .btn-update { background: #f39c12; color: white; }
        .btn-excel { background: #1d3557; color: white; }
        .btn-print { background: #495057; color: white; }
        .btn-wipe { background: #c1121f; color: white; margin-left: auto; }
        .btn-undo { background: #e67e22; color: white; }

        .import-section { display: flex; flex-wrap: wrap; align-items: center; gap: 10px; padding: 10px; border: 1px dashed #ccc; width: 100%; box-sizing: border-box; background: #fff; }
        .filters { display: flex; flex-wrap: wrap; gap: 10px; background: white; padding: 10px; border: 1px solid #dae1e7; border-radius: 4px; margin-bottom: 15px; align-items: center; }
        .search-box { flex: 1 1 200px; padding: 8px; border: 1px solid var(--da-green); }

        .table-wrap { overflow-x: auto; border: 1px solid #ccc; max-height: 500px; overflow-y: auto; background: white; width: 100%; }
        table { width: 100%; border-collapse: collapse; font-size: 0.7rem; min-width: 1400px; }
        th { background: var(--da-green); color: white; padding: 8px 4px; border: 1px solid #1e4d38; text-transform: uppercase; position: sticky; top: 0; z-index: 10; }
        td { border: 1px solid #ddd; padding: 5px; text-align: center; }
        tr:nth-child(even) { background: #f8fcf9; }

        .no-crop-highlight { background-color: #ffe5e5 !important; color: #b71c1c; font-weight: bold; }
        .total-row { background: var(--da-yellow) !important; font-weight: 900; border-top: 3px solid #000; }
        .hidden { display: none !important; }

        .signatory-container { margin-top: 20px; display: flex; justify-content: space-between; padding: 0 50px; page-break-inside: avoid; break-inside: avoid; }
        .sig-box { width: 220px; text-align: center; }
        .sig-name { font-weight: bold; border-bottom: 2px solid #000; text-transform: uppercase; padding-top: 20px; margin-bottom: 5px; font-size: 0.85rem; display: inline-block; width: 100%; }
        .sig-title { font-size: 0.7rem; font-weight: bold; color: #444; text-transform: uppercase; }

        #map { height: 400px; width: 100%; border-radius: 10px; border: 3px solid var(--primary-green); margin-bottom: 15px; }
        .calc-panel { background: #f1f3f5; padding: 15px; border-radius: 10px; margin-top: 10px; }
        .calc-stats { display: flex; justify-content: space-around; margin-bottom: 10px; }
        .calc-stat-item { text-align: center; }
        .calc-stat-item b { font-size: 1.2rem; color: var(--da-green); }

        .farm-list-overlay { max-height: 150px; overflow-y: auto; background: #fff; margin-top: 10px; border: 1px solid #ccc; font-size: 0.8rem; }
        .farm-list-item { padding: 5px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }

        @media (max-width: 768px) {
            header h1 { font-size: 1.2rem; }
            .analytics-bar { gap: 10px; }
            .stat-card { min-width: 45%; padding: 10px; }
            .stat-card p { font-size: 1rem; }
            .btn-wipe { margin-left: 0; } 
            .sig-input-area { flex-direction: column; }
            .signatory-container { justify-content: center; text-align: center; flex-direction: column; gap: 20px; }
            #map { height: 300px; }
        }

        @media print {
            @page { size: landscape; margin: 0.5cm; }
            header, .back-nav-btn, .analytics-group, .menu-grid, #main-menu, .home-btn, .grid, .controls, .filters, .btn-wipe, .action-col, .sig-input-area, .import-section, .storage-monitor, .contact-footer-info, .calendar-container { display: none !important; }
            .section-view { display: block !important; padding: 0; }
            .table-wrap { max-height: none !important; overflow: visible !important; }
            table { font-size: 0.55rem; min-width: 100%; page-break-after: avoid; }
            thead { display: table-header-group !important; }
            th { display: table-cell !important; background: #2d6a4f !important; color: white !important; }
            td { display: table-cell !important; }
            .hidden { display: none !important; }
            .total-row { display: table-row !important; }
            .action-col, th:last-child, td:last-child { display: none !important; }
            .signatory-container { display: flex !important; flex-direction: row !important; margin-top: 30px; }
        }
    </style>
</head>
<body>

<header>
    <div class="header-title-container">
        <span id="logo-emoji">üåæ</span>
        <div>
            <h1>OFFICE OF THE MUNICIPAL AGRICULTURE</h1>
            <p>CALINTAAN FARMERS INFORMATION MANAGEMENT SYSTEM</p>
        </div>
    </div>
</header>

<button class="back-nav-btn" id="floatingBackBtn" onclick="goHome()">üè† Back to Dashboard</button>

<div class="analytics-group" id="analyticsBar">
    <div class="season-label">‚òÄÔ∏è Dry Season Overview</div>
    <div class="analytics-bar">
        <div class="stat-card">
             <h4>Registered Farmers</h4>
            <p id="totalFarmersDry">0</p>
        </div>
        <div class="stat-card">
            <h4>Total Cultivated Area</h4>
            <p id="totalAreaDry">0.00 Ha</p>
        </div>
        <div class="stat-card">
            <h4>Main Crop</h4>
            <p id="mainCropDry">N/A</p>
        </div>
    </div>

    <div class="season-label">üåßÔ∏è Wet Season Overview</div>
    <div class="analytics-bar">
        <div class="stat-card">
             <h4>Registered Farmers</h4>
            <p id="totalFarmersWet">0</p>
        </div>
        <div class="stat-card">
            <h4>Total Cultivated Area</h4>
            <p id="totalAreaWet">0.00 Ha</p>
        </div>
        <div class="stat-card">
            <h4>Main Crop</h4>
            <p id="mainCropWet">N/A</p>
        </div>
    </div>

    <div class="season-label">üèπ IP's Masterlist Overview</div>
    <div class="analytics-bar">
        <div class="stat-card">
             <h4>Registered IP Farmers</h4>
            <p id="totalFarmersIp">0</p>
        </div>
        <div class="stat-card">
            <h4>Total IP Area</h4>
            <p id="totalAreaIp">0.00 Ha</p>
        </div>
    </div>
</div>

<div class="container" id="main-menu">
    <h2 style="color: var(--primary-green);">Main Dashboard</h2>

    <div class="dashboard-search-container">
        <label style="font-weight: bold; display: block; margin-bottom: 10px; color: var(--primary-green);">FAST FINDER</label>
        <input type="text" id="dashSearch" class="dash-search-box" placeholder="Enter Farmer's Name..." onkeyup="quickSearch()">
        <div id="dashSearchResults" class="search-results-overlay"></div>
    </div>

    <button onclick="toggleCalendarView()" class="home-btn" style="margin: 10px auto; display: block;">
        üìÖ Toggle Activity Calendar
    </button>

    <div class="calendar-container hidden-calendar" id="calendarSection">
        <div class="calendar-header">
            <h3 style="margin:0">üóìÔ∏è Weekly Activities</h3>
            <div>
                <button onclick="prevMonth()" style="cursor:pointer; background:none; border:1px solid #ccc; border-radius:4px;">&lt;</button>
                <span id="monthYearDisplay" style="font-weight:bold; margin: 0 10px;"></span>
                <button onclick="nextMonth()" style="cursor:pointer; background:none; border:1px solid #ccc; border-radius:4px;">&gt;</button>
            </div>
        </div>
        <div class="calendar-grid" id="calendarGrid">
            <div class="calendar-day-head">Sun</div>
            <div class="calendar-day-head">Mon</div>
            <div class="calendar-day-head">Tue</div>
            <div class="calendar-day-head">Wed</div>
            <div class="calendar-day-head">Thu</div>
            <div class="calendar-day-head">Fri</div>
            <div class="calendar-day-head">Sat</div>
        </div>
        <div class="activity-note-area" id="noteEditor" style="display:none;">
            <p style="font-weight:bold; font-size:0.8rem; color:var(--primary-green); margin-bottom:5px;" id="selectedDateText"></p>
            <textarea id="calendarNote" placeholder="What did you do this day? Enter activities here..."></textarea>
            <button class="btn-save" style="width:100%; padding:10px;" onclick="saveCalendarNote()">Save Activity Note</button>
        </div>
    </div>

    <div class="menu-grid">
        <div class="card" onclick="openSection('Crops', '')">
            <img src="https://images.unsplash.com/photo-1523348837708-15d4a09cfac2?q=80&w=800" class="preview-img">
            <h3>Crops (Dry)</h3>
            <div class="badge" id="cropCount">0 Records</div>
        </div>
        <div class="card" onclick="openSection('WetSeason', '')">
            <img src="https://images.unsplash.com/photo-1530507629858-e4977d30e9e0?q=80&w=800" class="preview-img">
            <h3>Wet Season</h3>
            <div class="badge" id="wetSeasonCount">0 Records</div>
        </div>
        <div class="card" onclick="openSection('IPsMasterlist', '')">
            <img src="https://images.unsplash.com/photo-1518005020250-6eb5f3f2f669?q=80&w=800" class="preview-img">
            <h3>IP's Masterlist</h3>
            <div class="badge" id="ipCount">0 Records</div>
        </div>
        <div class="card" onclick="openSection('AreaCalc', 'Calculate farm area using GPS markers')">
             <h3>üìç Area measurements</h3>
            <div class="badge">GPS Tool</div>
        </div>
        <div class="card" onclick="openSection('Livestock', 'Monitoring swine health...')">
            <img src="https://images.unsplash.com/photo-1516467508483-a7212febe31a?q=80&w=800" class="preview-img">
            <h3>Livestock</h3>
            <div class="badge">0 Registered</div>
        </div>
    </div>

    <div class="contact-footer-info">
        _____________________________________________________________________________________
        <div class="contact-row">
            <span>üìû (043) 753-56</span>
            <span>LGU Calintaan, Occidental Mindoro</span>
        </div>
        <div class="contact-row">
            <span>üìß omagcalintaan@gmail.com</span>
        </div>
    </div>
</div>

<div class="container">
    <div id="detail-view" class="section-view">
        <button class="home-btn" onclick="goHome()">‚Üê Back to Main Dashboard</button>
        <div id="dynamic-content">
            <h1 id="view-title" style="color: var(--primary-green); font-size: 1.5rem; text-align: center;">Section Title</h1>
            <p id="view-description" style="font-size: 1rem; color: #444; line-height: 1.6; max-width: 800px; margin: 0 auto; text-align: center;"></p>
        </div>

        <div id="area-calc-app" class="hidden">
             <div class="fims-container">
                <div class="gov-header">
                    <h2>Republic of the Philippines</h2>
                    <h1>GPS Farm Area Measurements</h1>
                    <p>Mark corner points (as many as needed for curves) to get precise measurements</p>
                </div>

                <div class="grid" style="margin-bottom: 10px;">
                    <div class="field">
                        <label>Farmer Name for this measurement</label>
                        <input type="text" id="mapFarmerName" placeholder="Farmer's Full Name">
                    </div>
                    <div class="field">
                        <label>üîç Search Saved Farm</label>
                        <input type="text" id="mapSearchFarmer" placeholder="Enter name to find..." onkeyup="searchSavedFarms()">
                    </div>
                </div>
                
                <div id="map"></div>

                <div class="calc-panel">
                    <div class="calc-stats">
                        <div class="calc-stat-item">
                            <span class="stat-label">SQ. METERS</span><br>
                            <b id="map-area-m">0.00</b>
                        </div>
                        <div class="calc-stat-item">
                            <span class="stat-label">HECTARES</span><br>
                            <b id="map-area-ha">0.000</b>
                        </div>
                    </div>
                    <div class="controls">
                        <button class="btn-save" onclick="useGPS()">üìç Mark Current GPS Spot</button>
                        <button class="btn-update" id="mapSaveBtn" onclick="saveFarmPolygon()">üíæ Save Farm Area</button>
                        <button class="btn-wipe" onclick="clearMap()">üóëÔ∏è Clear Current Points</button>
                    </div>
                    
                    <div id="savedFarmList" class="farm-list-overlay"></div>
                </div>
             </div>
        </div>

        <div id="fims-app" class="hidden">
            <div class="fims-container">
                <div class="storage-monitor" id="storageVal">FIMS System: Active</div>
                <div class="gov-header">
                    <h2>Republic of the Philippines</h2>
                    <h1>Office of the Municipal Agriculture</h1>
                    <p>Calintaan Farmers Information Management System (FIMS)</p>
                    <h3 id="masterTitle" style="margin-top:10px; color:var(--gov-blue); text-align: center; font-size: 1rem;">MASTERLIST OF BARANGAY ______________</h3>
                </div>

                <input type="hidden" id="editIndex" value="-1">
                
                <div class="grid" id="entryForm">
                    <div class="field">
                         <label>Target Barangay</label>
                        <select id="loc" onchange="updateHeader()">
                            <option value="">-- SELECT BARANGAY --</option>
                            <option value="Concepcion">Concepcion</option>
                            <option value="Iriron">Iriron</option>
                            <option value="Malpalon">Malpalon</option>
                            <option value="New Dagupan">New Dagupan</option>
                            <option value="Poblacion">Poblacion</option>
                            <option value="Poypoy">Poypoy</option>
                            <option value="Tanyag">Tanyag</option>
                         </select>
                    </div>
                    <div class="field"><label>FIMS Reference #</label><input type="text" id="fims" placeholder="00-000-000"></div>
                    <div class="field"><label>Farmer Full Name</label><input type="text" id="name" placeholder="Last, First Middle"></div>
                    <div class="field"><label>Date of Birth</label><input type="date" id="bday"></div>
                    <div class="field"><label>Farm Location</label><input type="text" id="location"></div>
                    <div class="field"><label>GPS Geotag</label><input type="text" id="geo" step="any"></div>
                    <div class="field"><label>Irrigated (Ha)</label><input type="number" step="0.01" id="irr"></div>
                    <div class="field"><label>Rainfed (Ha)</label><input type="number" step="0.01" id="rf"></div>
                    <div class="field"><label>Upland (Ha)</label><input type="number" step="0.01" id="upland"></div>
                    <div class="field"><label id="riceLabel">Rice Area</label><input type="number" step="0.01" id="rice"></div>
                    <div class="field"><label id="cornLabel">Corn Area</label><input type="number" step="0.01" id="corn"></div>
                    <div class="field"><label id="onionLabel">Onion Area</label><input type="number" step="0.01" id="onion"></div>
                    <div class="field"><label id="mungLabel">Mungbean</label><input type="number" step="0.01" id="mung"></div>
                    <div class="field"><label id="vegLabel">Vegetables</label><input type="number" step="0.01" id="veg"></div>
                    <div class="field"><label id="vegTypeLabel">Specify Vegetable Type</label><input type="text" id="vegType" placeholder="e.g. Tomato, Eggplant"></div>
                    <div class="field"><label id="melonLabel">Water Melon</label><input type="number" step="0.01" id="melon"></div>
                    <div class="field"><label id="othersLabel">Other Crops (Ha)</label><input type="number" step="0.01" id="others"></div>
                    <div class="field"><label id="cropDescLabel">Specify Other Crop</label><input type="text" id="cropDesc" placeholder="e.g. Tobacco / Peanuts"></div>
                    <div class="field"><label>Note</label><input type="text" id="note" placeholder="Enter remarks..."></div>
                </div>

                <div class="controls">
                    <div class="import-section">
                        <label style="color:var(--gov-blue); font-size: 0.7rem; font-weight: bold;">DATA IMPORT:</label>
                        <input type="file" id="excelUpload" accept=".xlsx, .xls">
                        <button class="btn-save" onclick="importFile()">Process File</button>
                        <button id="undoBtn" class="btn-undo hidden" onclick="undoImport()">‚Ü© Undo Last Import</button>
                    </div>
                    <button id="saveBtn" class="btn-save" onclick="saveData()">+ Add New Record</button>
                    <button class="btn-sort" onclick="sortAZ()">Sort A-Z</button>
                    <button class="btn-reset" onclick="resetSort()">Reset Sort</button>
                    <button class="btn-excel" onclick="exportExcel()">‚¨á Export to Excel</button>
                    <button class="btn-print" onclick="window.print()">‚éô Generate Report</button>
                    <button class="btn-wipe" onclick="wipeDB()">Clear Database</button>

                    <div class="sig-input-area" style="width: 100%; display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px;">
                        <div class="field"><label>Name of LFT:</label><input type="text" id="lftInput" onkeyup="syncSig()"></div>
                        <div class="field"><label>LFT Designation:</label><input type="text" id="lftDesignationInput" onkeyup="syncSig()" value="Local Farmer Technician (LFT)"></div>
                        <div class="field"><label>Attesting Officer Name:</label><input type="text" id="atInput" onkeyup="syncSig()"></div>
                        <div class="field"><label>Officer Designation:</label><input type="text" id="atDesignationInput" onkeyup="syncSig()" value="Agricultural Technician"></div>
                    </div>
                </div>

                <div class="filters">
                    <input type="text" id="searchBar" class="search-box" placeholder="üîé Search by Farmer Name..." onkeyup="refreshTable()">
                    <input type="text" id="locationFilter" class="search-box" placeholder="üìç Filter by Farm Location..." onkeyup="refreshTable()">
                    <select id="landFilter" onchange="refreshTable()"><option value="all">All Land</option><option value="irr">Irrigated</option><option value="rf">Rainfed</option><option value="upland">Upland</option></select>
                    <select id="cropFilter" onchange="refreshTable()">
                        <option value="all">All Crops</option>
                        <option value="rice">Rice</option>
                        <option id="optCorn" value="corn">Corn</option>
                        <option id="optOnion" value="onion">Onion</option>
                        <option id="optMung" value="mung">Mungbean</option>
                        <option id="optVeg" value="veg">Vegetables</option>
                        <option id="optMelon" value="melon">Water Melon</option>
                        <option value="others">Others</option>
                        <option value="group_hv">Onion/Mung/Veg/Melon/Others</option>
                        <option value="group_rc">Rice & Corn Only</option>
                    </select>
                    <select id="viewFilter" onchange="refreshTable()">
                        <option value="all">All Brgy</option>
                        <option value="Concepcion">Concepcion</option>
                        <option value="Iriron">Iriron</option>
                        <option value="Malpalon">Malpalon</option>
                        <option value="New Dagupan">New Dagupan</option>
                        <option value="Poblacion">Poblacion</option>
                        <option value="Poypoy">Poypoy</option>
                        <option value="Tanyag">Tanyag</option>
                    </select>
                </div>

                <div class="table-wrap">
                    <table id="dataTable">
                        <thead>
                            <tr><th>FIMS #</th><th>Full Name</th><th>Birth Date</th><th>Location</th><th>Barangay</th><th>Geotag</th><th>IRR.</th><th>RF</th><th>Upland</th><th>Rice</th><th id="thCorn">Corn</th><th id="thOnion">Onion</th><th id="thMung">Mung</th><th id="thVeg">Veg</th><th id="thVegType">Veg. Type</th><th id="thMelon">Melon</th><th id="thOthers">Others (Ha)</th><th style="background: var(--gov-blue); color: white;">Other Crop Name</th><th class="action-col">Note</th><th class="action-col">Tools</th></tr>
                        </thead>
                        <tbody id="tbody"></tbody>
                    </table>
                </div>

                <div class="signatory-container">
                    <div class="sig-box">
                        <p style="text-align: left; font-size: 0.75rem; margin-bottom: 20px;">Prepared by:</p>
                        <div class="sig-name" id="sigLft"></div>
                        <div class="sig-title" id="sigLftTitle">Local Farmer Technician (LFT)</div>
                    </div>
                    <div class="sig-box">
                        <p style="text-align: left; font-size: 0.75rem; margin-bottom: 20px;">Attested by:</p>
                        <div class="sig-name" id="sigAt"></div>
                        <div class="sig-title" id="sigAtTitle">Agricultural Technician</div>
                    </div>
                </div>
             </div>
        </div>
    </div>
</div>

<script>
    let currentDate = new Date();
    let selectedDateKey = "";
    let calendarNotes = JSON.parse(localStorage.getItem('fims_calendar_notes')) || {};

    let leafMap = null;
    let mapMarkers = [];
    let mapPolygon = null;
    let savedFarms = JSON.parse(localStorage.getItem('fims_saved_farms')) || [];
    let activeFarmsOnMap = [];
    let editFarmId = null;

    // HISTORY STACK FOR UNDO
    let dbHistory = [];

    function initAreaMap() {
        if (leafMap) return;
        leafMap = L.map('map').setView([12.593, 121.047], 13);
        L.tileLayer('https://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
            maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3']
        }).addTo(leafMap);

        leafMap.on('click', function(e) {
            addMapPoint(e.latlng);
        });
        loadSavedFarmsToMap();
    }

    function useGPS() {
        leafMap.locate({setView: true, maxZoom: 18, enableHighAccuracy: true});
    }

    function addMapPoint(latlng) {
        const marker = L.marker(latlng, {draggable: true}).addTo(leafMap);
        mapMarkers.push(marker);
        marker.on('drag', updateAreaCalc);
        updateAreaCalc();
    }

    function updateAreaCalc() {
        const coords = mapMarkers.map(m => m.getLatLng());
        if (mapPolygon) leafMap.removeLayer(mapPolygon);
        if (coords.length > 2) {
            mapPolygon = L.polygon(coords, {color: 'yellow', weight: 2, fillOpacity: 0.4}).addTo(leafMap);
            let area = 0;
            const R = 6378137;
            for (let i = 0; i < coords.length; i++) {
                let p1 = coords[i]; let p2 = coords[(i + 1) % coords.length];
                area += (p2.lng * Math.PI / 180 - p1.lng * Math.PI / 180) * (2 + Math.sin(p1.lat * Math.PI / 180) + Math.sin(p2.lat * Math.PI / 180));
            }
            area = Math.abs(area * R * R / 2.0);
            document.getElementById('map-area-m').innerText = area.toLocaleString(undefined, {maximumFractionDigits: 2});
            document.getElementById('map-area-ha').innerText = (area / 10000).toFixed(3);
        }
    }

    function saveFarmPolygon() {
        const name = document.getElementById('mapFarmerName').value;
        const areaHa = document.getElementById('map-area-ha').innerText;
        if (!name || mapMarkers.length < 3) return alert("Please enter farmer name and mark at least 3 points.");

        const coords = mapMarkers.map(m => ({lat: m.getLatLng().lat, lng: m.getLatLng().lng}));
        const farmObj = { id: editFarmId || Date.now(), name, area: areaHa, coords };

        if (editFarmId) {
            const idx = savedFarms.findIndex(f => f.id === editFarmId);
            savedFarms[idx] = farmObj;
            editFarmId = null;
            document.getElementById('mapSaveBtn').innerText = "üíæ Save Farm Area";
        } else {
            savedFarms.push(farmObj);
        }

        localStorage.setItem('fims_saved_farms', JSON.stringify(savedFarms));
        alert("Farm saved successfully!");
        clearMap();
        loadSavedFarmsToMap();
        document.getElementById('mapFarmerName').value = "";
    }

    function loadSavedFarmsToMap() {
        activeFarmsOnMap.forEach(f => leafMap.removeLayer(f.poly));
        activeFarmsOnMap = [];

        savedFarms.forEach(farm => {
            const poly = L.polygon(farm.coords, {color: 'white', weight: 1, fillOpacity: 0.2}).addTo(leafMap);
            poly.bindPopup(`<b>${farm.name}</b><br>Area: ${farm.area} Ha`);
            activeFarmsOnMap.push({id: farm.id, poly: poly, name: farm.name});
        });
        searchSavedFarms(); 
    }

    function searchSavedFarms() {
        const query = document.getElementById('mapSearchFarmer').value.toLowerCase();
        const listDiv = document.getElementById('savedFarmList');
        listDiv.innerHTML = '';
        
        savedFarms.filter(f => f.name.toLowerCase().includes(query)).forEach(farm => {
            const div = document.createElement('div');
            div.className = 'farm-list-item';
            div.innerHTML = `<span>${farm.name} (${farm.area} Ha)</span> 
                             <div>
                                <button onclick="traceFarm(${farm.id})" style="background:blue; color:white; border:none; padding:2px 5px; border-radius:3px;">üîç</button>
                                <button onclick="editFarm(${farm.id})" style="background:orange; color:white; border:none; padding:2px 5px; border-radius:3px;">Edit</button>
                                <button onclick="deleteFarm(${farm.id})" style="background:red; color:white; border:none; padding:2px 5px; border-radius:3px;">Del</button>
                             </div>`;
            listDiv.appendChild(div);
        });
    }

    function traceFarm(id) {
        const farm = savedFarms.find(f => f.id === id);
        if (farm) {
            leafMap.fitBounds(L.polygon(farm.coords).getBounds());
        }
    }

    function editFarm(id) {
        const farm = savedFarms.find(f => f.id === id);
        if (!farm) return;
        clearMap();
        editFarmId = id;
        document.getElementById('mapFarmerName').value = farm.name;
        document.getElementById('mapSaveBtn').innerText = "üíæ Update Changes";
        farm.coords.forEach(c => addMapPoint([c.lat, c.lng]));
        leafMap.fitBounds(L.polygon(farm.coords).getBounds());
    }

    function deleteFarm(id) {
        if (!confirm("Delete this farm record?")) return;
        savedFarms = savedFarms.filter(f => f.id !== id);
        localStorage.setItem('fims_saved_farms', JSON.stringify(savedFarms));
        loadSavedFarmsToMap();
    }

    function clearMap() {
        mapMarkers.forEach(m => leafMap.removeLayer(m));
        if (mapPolygon) leafMap.removeLayer(mapPolygon);
        mapMarkers = [];
        editFarmId = null;
        document.getElementById('mapSaveBtn').innerText = "üíæ Save Farm Area";
        document.getElementById('map-area-m').innerText = "0.00";
        document.getElementById('map-area-ha').innerText = "0.000";
    }

    function toggleCalendarView() {
        const cal = document.getElementById('calendarSection');
        cal.classList.toggle('hidden-calendar');
    }

    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        const display = document.getElementById('monthYearDisplay');
        const month = currentDate.getMonth();
        const year = currentDate.getFullYear();
        
        display.innerText = new Intl.DateTimeFormat('en-US', { month: 'long', year: 'numeric' }).format(currentDate);
        const headers = Array.from(grid.querySelectorAll('.calendar-day-head'));
        grid.innerHTML = '';
        headers.forEach(h => grid.appendChild(h));

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        for(let i=0; i<firstDay; i++){
            const div = document.createElement('div');
            grid.appendChild(div);
        }

        const today = new Date();
        for(let day=1; day<=daysInMonth; day++){
            const div = document.createElement('div');
            div.className = 'calendar-day';
            const dateKey = `${year}-${month + 1}-${day}`;
            
            const dateSpan = document.createElement('span');
            dateSpan.innerText = day;
            div.appendChild(dateSpan);
            
            if(day === today.getDate() && month === today.getMonth() && year === today.getFullYear()){
                div.classList.add('today');
            }
            
            if(calendarNotes[dateKey]) {
                const pin = document.createElement('div');
                pin.className = 'pin-icon';
                pin.innerText = "üìå";
                div.appendChild(pin);
            }

            div.onclick = () => selectCalendarDate(year, month, day);
            grid.appendChild(div);
        }
    }

    function selectCalendarDate(y, m, d) {
        const newDateKey = `${y}-${m + 1}-${d}`;
        const noteEditor = document.getElementById('noteEditor');
        
        if (selectedDateKey === newDateKey && noteEditor.style.display === 'block') {
            noteEditor.style.display = 'none';
            selectedDateKey = ""; 
        } else {
            selectedDateKey = newDateKey;
            noteEditor.style.display = 'block';
            document.getElementById('selectedDateText').innerText = `Activity for: ${new Date(y, m, d).toDateString()}`;
            document.getElementById('calendarNote').value = calendarNotes[selectedDateKey] || "";
        }
    }

    function saveCalendarNote() {
        const note = document.getElementById('calendarNote').value;
        if(note.trim() === "") {
            delete calendarNotes[selectedDateKey];
        } else {
            calendarNotes[selectedDateKey] = note;
        }
        localStorage.setItem('fims_calendar_notes', JSON.stringify(calendarNotes));
        renderCalendar();
        alert("Note saved!");
    }

    function prevMonth() { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); }
    function nextMonth() { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); }

    let activeSeason = 'dry'; 
    let db = []; 
    let wetDb = []; 
    let ipDb = [];
    
    try { db = JSON.parse(localStorage.getItem('fims_calintaan_v3')) || []; } catch(e) { db = []; }
    try { wetDb = JSON.parse(localStorage.getItem('fims_calintaan_wet')) || []; } catch(e) { wetDb = []; }
    try { ipDb = JSON.parse(localStorage.getItem('fims_calintaan_ips')) || []; } catch(e) { ipDb = []; }

    function updateIpHeadings(isIp) {
        const labels = {
            corn: isIp ? "Ube Area" : "Corn Area",
            onion: isIp ? "Ginger Area" : "Onion Area",
            mung: isIp ? "Mungbean Area" : "Mungbean",
            veg: isIp ? "Taro Area" : "Vegetables",
            vegType: isIp ? "Taro Variety" : "Specify Vegetable Type",
            melon: isIp ? "Sweet Potato" : "Water Melon",
            others: isIp ? "Chili Area" : "Other Crops (Ha)",
            cropDesc: isIp ? "Cassava / Others" : "Specify Other Crop"
        };
        
        document.getElementById('cornLabel').innerText = labels.corn;
        document.getElementById('onionLabel').innerText = labels.onion;
        document.getElementById('mungLabel').innerText = labels.mung;
        document.getElementById('vegLabel').innerText = labels.veg;
        document.getElementById('vegTypeLabel').innerText = labels.vegType;
        document.getElementById('melonLabel').innerText = labels.melon;
        document.getElementById('othersLabel').innerText = labels.others;
        document.getElementById('cropDescLabel').innerText = labels.cropDesc;

        document.getElementById('thCorn').innerText = isIp ? "UBE" : "CORN";
        document.getElementById('thOnion').innerText = isIp ? "GINGER" : "ONION";
        document.getElementById('thMung').innerText = isIp ? "MUNGBEAN" : "MUNG";
        document.getElementById('thVeg').innerText = isIp ? "TARO" : "VEG";
        document.getElementById('thVegType').innerText = isIp ? "T.VARIETY" : "VEG. TYPE";
        document.getElementById('thMelon').innerText = isIp ? "S. POTATO" : "MELON";
        document.getElementById('thOthers').innerText = isIp ? "CHILI" : "OTHERS";

        document.getElementById('optCorn').innerText = isIp ? "Ube" : "Corn";
        document.getElementById('optOnion').innerText = isIp ? "Ginger" : "Onion";
        document.getElementById('optMung').innerText = isIp ? "Mungbean" : "Mungbean";
        document.getElementById('optVeg').innerText = isIp ? "Taro" : "Vegetables";
        document.getElementById('optMelon').innerText = isIp ? "Sweet Potato" : "Water Melon";
    }

    function openSection(title, description) {
        document.getElementById('logo-emoji').style.display = 'none';
        document.getElementById('main-menu').style.display = 'none';
        document.getElementById('analyticsBar').style.display = 'none';
        document.getElementById('floatingBackBtn').style.display = 'block'; 
        const detailView = document.getElementById('detail-view');
        detailView.style.display = 'block';
        
        const fimsApp = document.getElementById('fims-app');
        const areaApp = document.getElementById('area-calc-app');
        const dynamicText = document.getElementById('dynamic-content');

        fimsApp.classList.add('hidden');
        areaApp.classList.add('hidden');
        dynamicText.classList.add('hidden');

        if(title === 'Crops') {
            activeSeason = 'dry';
            fimsApp.classList.remove('hidden');
            document.getElementById('masterTitle').innerText = "DRY SEASON MASTERLIST OF BARANGAY ______________";
            updateIpHeadings(false);
            refreshTable();
        } else if(title === 'WetSeason') {
            activeSeason = 'wet';
            fimsApp.classList.remove('hidden');
            document.getElementById('masterTitle').innerText = "WET SEASON MASTERLIST OF BARANGAY ______________";
            updateIpHeadings(false);
            refreshTable();
        } else if(title === 'IPsMasterlist') {
            activeSeason = 'ips';
            fimsApp.classList.remove('hidden');
            document.getElementById('masterTitle').innerText = "IP'S MASTERLIST OF BARANGAY ______________";
            updateIpHeadings(true);
            refreshTable();
        } else if(title === 'AreaCalc') {
            areaApp.classList.remove('hidden');
            setTimeout(initAreaMap, 200);
        } else {
            dynamicText.classList.remove('hidden');
            document.getElementById('view-title').innerText = title;
            document.getElementById('view-description').innerText = description;
        }
    }

    function goHome() {
        document.getElementById('logo-emoji').style.display = 'inline-block';
        document.getElementById('main-menu').style.display = 'block';
        document.getElementById('analyticsBar').style.display = 'flex';
        document.getElementById('detail-view').style.display = 'none';
        document.getElementById('floatingBackBtn').style.display = 'none'; 
        updateDashboardAnalytics();
    }

    function quickSearch() {
        const query = document.getElementById('dashSearch').value.toLowerCase();
        const resultsDiv = document.getElementById('dashSearchResults');
        resultsDiv.innerHTML = '';
        if (query.length < 1) return;
        
        const combined = [
            ...db.map(x => ({...x, season:'Dry', sid:'Crops'})), 
            ...wetDb.map(x => ({...x, season:'Wet', sid:'WetSeason'})),
            ...ipDb.map(x => ({...x, season:'IP', sid:'IPsMasterlist'}))
        ];
        const matches = combined.filter((item) => (item.name || "").toLowerCase().includes(query)).slice(0, 5);
        
        matches.forEach(farmer => {
            const div = document.createElement('div');
            div.className = 'search-item';
            div.innerHTML = `
                <div>
                    <span>${farmer.name}</span> <br>
                    <small>FIMS: ${farmer.fims || 'N/A'} | Brgy: ${farmer.loc || 'N/A'}</small>
                </div>
                <div style="text-align:right">
                    <span class="badge" style="background:var(--primary-green); color:white;">${farmer.season}</span>
                </div>
            `;
            div.onclick = () => { 
                openSection(farmer.sid, ''); 
                document.getElementById('searchBar').value = farmer.name; 
                refreshTable(); 
            };
            resultsDiv.appendChild(div);
        });
    }

    function calculateStats(targetDb) {
        const uniqueNames = new Set();
        let totalHa = 0;
        const cropTotals = { "Rice": 0, "Corn": 0, "Onion": 0, "Mungbean": 0, "Vegetables": 0, "Water Melon": 0, "Others": 0 };
        const cropFieldsList = ['rice', 'corn', 'onion', 'mung', 'veg', 'melon', 'others'];

        targetDb.forEach(item => {
            const name = (item.name || "").trim().toLowerCase();
            const hasCrops = cropFieldsList.some(field => parseFloat(item[field]) > 0);
            if (hasCrops && name) {
                uniqueNames.add(name);
                cropFieldsList.forEach(f => {
                    let val = parseFloat(item[f]) || 0;
                    totalHa += val;
                });
                cropTotals["Rice"] += parseFloat(item.rice) || 0;
                cropTotals["Corn"] += parseFloat(item.corn) || 0;
                cropTotals["Onion"] += parseFloat(item.onion) || 0;
                cropTotals["Mungbean"] += parseFloat(item.mung) || 0;
                cropTotals["Vegetables"] += parseFloat(item.veg) || 0;
                cropTotals["Water Melon"] += parseFloat(item.melon) || 0;
                cropTotals["Others"] += parseFloat(item.others) || 0;
            }
        });

        let mainCropName = "N/A";
        let maxVal = 0;
        for (const crop in cropTotals) {
            if (cropTotals[crop] > maxVal) {
                maxVal = cropTotals[crop];
                mainCropName = crop;
            }
        }

        return { count: uniqueNames.size, area: totalHa.toFixed(2), mainCrop: mainCropName };
    }

    function updateDashboardAnalytics() {
        const dryStats = calculateStats(db);
        document.getElementById('totalFarmersDry').innerText = dryStats.count;
        document.getElementById('totalAreaDry').innerText = `${dryStats.area} Ha`;
        document.getElementById('mainCropDry').innerText = dryStats.mainCrop;

        const wetStats = calculateStats(wetDb);
        document.getElementById('totalFarmersWet').innerText = wetStats.count;
        document.getElementById('totalAreaWet').innerText = `${wetStats.area} Ha`;
        document.getElementById('mainCropWet').innerText = wetStats.mainCrop;

        const ipStats = calculateStats(ipDb);
        document.getElementById('totalFarmersIp').innerText = ipStats.count;
        document.getElementById('totalAreaIp').innerText = `${ipStats.area} Ha`;

        document.getElementById('cropCount').innerText = `${db.length} Records`;
        document.getElementById('wetSeasonCount').innerText = `${wetDb.length} Records`;
        document.getElementById('ipCount').innerText = `${ipDb.length} Records`;
    }

    const fields = ['fims', 'name', 'bday', 'location', 'loc', 'geo', 'irr', 'rf', 'upland', 'rice', 'corn', 'onion', 'mung', 'veg', 'vegType', 'melon', 'others', 'cropDesc', 'note'];
    const summaryFields = ['geo', 'irr', 'rf', 'upland', 'rice', 'corn', 'onion', 'mung', 'veg', 'melon', 'others'];
    const cropFields = ['irr', 'rf', 'upland', 'rice', 'corn', 'onion', 'mung', 'veg', 'vegType', 'melon', 'others'];

    window.onload = () => { 
        refreshTable(); 
        updateDashboardAnalytics();
        renderCalendar(); 
    };

    function updateHeader() {
        const val = document.getElementById('loc').value;
        let seasonText = "DRY SEASON";
        if(activeSeason === 'wet') seasonText = "WET SEASON";
        if(activeSeason === 'ips') seasonText = "IP'S";
        document.getElementById('masterTitle').innerText = val ? `${seasonText} MASTERLIST OF BARANGAY ${val.toUpperCase()}` : `${seasonText} MASTERLIST OF BARANGAY ______________`;
    }

    function syncSig() {
        document.getElementById('sigLft').innerText = document.getElementById('lftInput').value;
        document.getElementById('sigLftTitle').innerText = document.getElementById('lftDesignationInput').value;
        document.getElementById('sigAt').innerText = document.getElementById('atInput').value;
        document.getElementById('sigAtTitle').innerText = document.getElementById('atDesignationInput').value;
    }

    function saveData() {
        const brgy = document.getElementById('loc').value;
        const nameInput = document.getElementById('name').value;
        const locationInput = document.getElementById('location').value; 
        const geoInput = document.getElementById('geo').value;
        const editIdx = parseInt(document.getElementById('editIndex').value);
        
        if(!brgy || !nameInput) return alert("Validation Error: Barangay and Name are required.");

        const geotagLimit = parseFloat(geoInput) || 0;
        const riceVal = parseFloat(document.getElementById('rice').value) || 0;
        const cornVal = parseFloat(document.getElementById('corn').value) || 0;
        const onionVal = parseFloat(document.getElementById('onion').value) || 0;
        const mungVal = parseFloat(document.getElementById('mung').value) || 0;
        const vegVal = parseFloat(document.getElementById('veg').value) || 0;
        const melonVal = parseFloat(document.getElementById('melon').value) || 0;
        const othersVal = parseFloat(document.getElementById('others').value) || 0;
        
        const rawSum = riceVal + cornVal + onionVal + mungVal + vegVal + melonVal + othersVal;
        const totalCropArea = Math.round(rawSum * 10000) / 10000;
        const limitRounded = Math.round(geotagLimit * 10000) / 10000;
        
        if (totalCropArea > limitRounded) {
            return alert(`ERROR: Total crop area (${totalCropArea} Ha) exceeds the declared GPS Geotag area (${limitRounded} Ha).`);
        }

        let currentDb = db;
        let dbKey = 'fims_calintaan_v3';
        if(activeSeason === 'wet') { currentDb = wetDb; dbKey = 'fims_calintaan_wet'; }
        if(activeSeason === 'ips') { currentDb = ipDb; dbKey = 'fims_calintaan_ips'; }

        const isDuplicate = currentDb.some((entry, idx) => {
            if (editIdx !== -1 && idx === editIdx) return false;
            return (entry.name || "").trim().toLowerCase() === nameInput.trim().toLowerCase() && 
                   (entry.geo || "") === geoInput && 
                   (entry.location || "").trim().toLowerCase() === locationInput.trim().toLowerCase();
        });

        if (isDuplicate) return alert("Error: Duplicate record found in this specific location.");

        let f = {};
        fields.forEach(k => f[k] = document.getElementById(k).value);
        
        if (editIdx === -1) {
            currentDb.push(f);
        } else {
            currentDb[editIdx] = f;
            document.getElementById('editIndex').value = "-1";
            document.getElementById('saveBtn').innerText = "+ Add New Record";
            document.getElementById('saveBtn').className = "btn-save";
        }
        
        localStorage.setItem(dbKey, JSON.stringify(currentDb));
        fields.forEach(k => { if(k !== 'loc') document.getElementById(k).value = ''; });
        refreshTable(); updateDashboardAnalytics();
    }

    function editItem(idx) {
        let currentDb = db;
        if(activeSeason === 'wet') currentDb = wetDb;
        if(activeSeason === 'ips') currentDb = ipDb;
        const item = currentDb[idx];
        fields.forEach(k => document.getElementById(k).value = item[k] || '');
        document.getElementById('editIndex').value = idx;
        document.getElementById('saveBtn').innerText = "üíæ Save Changes";
        document.getElementById('saveBtn').className = "btn-update";
        window.scrollTo({top: 0, behavior: 'smooth'});
    }

    function sortAZ() { 
        let currentDb = db;
        if(activeSeason === 'wet') currentDb = wetDb;
        if(activeSeason === 'ips') currentDb = ipDb;
        currentDb.sort((a, b) => (a.name || "").toLowerCase().localeCompare((b.name || "").toLowerCase()));
        refreshTable(); 
    }
    
    function resetSort() { 
        if(activeSeason === 'dry') {
            db = JSON.parse(localStorage.getItem('fims_calintaan_v3')) || []; 
        } else if(activeSeason === 'wet') {
            wetDb = JSON.parse(localStorage.getItem('fims_calintaan_wet')) || [];
        } else {
            ipDb = JSON.parse(localStorage.getItem('fims_calintaan_ips')) || [];
        }
        document.getElementById('searchBar').value = '';
        document.getElementById('locationFilter').value = '';
        document.getElementById('viewFilter').value = 'all';
        document.getElementById('cropFilter').value = 'all';
        document.getElementById('landFilter').value = 'all';
        refreshTable(); 
        updateDashboardAnalytics();
    }

    function refreshTable() {
        const tbody = document.getElementById('tbody');
        const vFilt = document.getElementById('viewFilter').value;
        const cFilt = document.getElementById('cropFilter').value;
        const lFilt = document.getElementById('landFilter').value;
        const search = document.getElementById('searchBar').value.toLowerCase();
        const locSearch = document.getElementById('locationFilter').value.toLowerCase();
        const areaFields = ['rice', 'corn', 'onion', 'mung', 'veg', 'melon', 'others'];
        updateColumnHeaders(cFilt, lFilt);
        tbody.innerHTML = '';
        let totals = {};
        summaryFields.forEach(f => totals[f] = 0);
        let visibleCount = 0;
        
        let currentDb = db;
        if(activeSeason === 'wet') currentDb = wetDb;
        if(activeSeason === 'ips') currentDb = ipDb;

        currentDb.forEach((item, originalIdx) => {
            const matchBrgy = (vFilt === 'all' || item.loc === vFilt);
            const matchSearch = (item.name || "").toLowerCase().includes(search);
            const matchLoc = (item.location || "").toLowerCase().includes(locSearch);
            
            let matchCrop = false;
            if (cFilt === 'all') matchCrop = true;
            else if (cFilt === 'group_hv') matchCrop = (parseFloat(item.onion) > 0 || parseFloat(item.mung) > 0 || parseFloat(item.veg) > 0 || parseFloat(item.melon) > 0 || parseFloat(item.others) > 0);
            else if (cFilt === 'group_rc') matchCrop = (parseFloat(item.rice) > 0 || parseFloat(item.corn) > 0);
            else matchCrop = (parseFloat(item[cFilt]) > 0);

            const matchLand = (lFilt === 'all') ? true : (parseFloat(item[lFilt]) > 0);
            const hasCrops = areaFields.some(field => parseFloat(item[field]) > 0);

            if(matchBrgy && matchSearch && matchLoc && matchCrop && matchLand) {
                visibleCount++;
                const row = tbody.insertRow();
                if (!hasCrops) row.classList.add('no-crop-highlight');
                fields.forEach(k => {
                    const cell = row.insertCell();
                    cell.innerText = item[k] || '';
                    if(summaryFields.includes(k)) totals[k] += parseFloat(item[k]) || 0;
                    
                    if(cropFields.includes(k) && !['irr','rf','upland'].includes(k)) {
                        if (cFilt === 'group_hv' && !['onion', 'mung', 'veg', 'vegType', 'melon', 'others'].includes(k)) cell.classList.add('hidden');
                        else if (cFilt === 'group_rc' && !['rice', 'corn'].includes(k)) cell.classList.add('hidden');
                        else if (cFilt !== 'all' && cFilt !== 'group_hv' && cFilt !== 'group_rc' && k !== cFilt && k !== 'vegType') {
                             if(cFilt === 'veg' && k === 'vegType') { /* show vegType if veg is selected */ } else { cell.classList.add('hidden'); }
                        }
                        if (cFilt !== 'all' && cFilt !== 'group_hv' && cFilt !== 'veg' && k === 'vegType') cell.classList.add('hidden');
                    }
                    
                    if(['irr','rf','upland'].includes(k) && lFilt !== 'all' && k !== lFilt) cell.classList.add('hidden');
                    if(k === 'cropDesc') {
                         if (cFilt === 'group_rc' || (cFilt !== 'all' && cFilt !== 'group_hv' && cFilt !== 'others')) cell.classList.add('hidden');
                    }
                    if(k === 'note') cell.classList.add('action-col');
                });
                const actionCell = row.insertCell();
                actionCell.className = "action-col";
                actionCell.innerHTML = `<button onclick="editItem(${originalIdx})" style="background:#f39c12; color:white; padding:4px 8px; border:none; border-radius:3px; font-size:0.6rem;">Edit</button>
                    <button onclick="deleteItem(${originalIdx})" style="background:#c1121f; color:white; padding:4px 8px; border:none; border-radius:3px; margin-left:3px; font-size:0.6rem;">Del</button>`;
            }
        });
        if(visibleCount > 0) {
            const tRow = tbody.insertRow();
            tRow.classList.add('total-row');
            fields.forEach(k => {
                const cell = tRow.insertCell();
                if(k === 'fims') cell.innerText = `TOTAL: ${visibleCount}`;
                else if(summaryFields.includes(k)) {
                    cell.innerText = (k === 'geo') ? totals[k].toString() : totals[k].toFixed(2);
                    
                    if(cropFields.includes(k) && !['irr','rf','upland'].includes(k)) {
                        if (cFilt === 'group_hv' && !['onion', 'mung', 'veg', 'melon', 'others'].includes(k)) cell.classList.add('hidden');
                        else if (cFilt === 'group_rc' && !['rice', 'corn'].includes(k)) cell.classList.add('hidden');
                        else if (cFilt !== 'all' && cFilt !== 'group_hv' && cFilt !== 'group_rc' && k !== cFilt) cell.classList.add('hidden');
                    }
                    if(['irr','rf','upland'].includes(k) && lFilt !== 'all' && k !== lFilt) cell.classList.add('hidden');
                }
                if(k === 'vegType') {
                    if (cFilt !== 'all' && cFilt !== 'group_hv' && cFilt !== 'veg') cell.classList.add('hidden');
                }
                if(k === 'note') cell.classList.add('action-col');
            });
            tRow.insertCell().className = "action-col";
        }
    }

    function updateColumnHeaders(selectedCrop, selectedLand) {
        const headers = document.querySelectorAll('#dataTable thead th');
        fields.forEach((key, index) => {
            if (cropFields.includes(key) && !['irr','rf','upland'].includes(key)) {
                if (selectedCrop === 'group_hv') {
                    if (['onion', 'mung', 'veg', 'vegType', 'melon', 'others'].includes(key)) headers[index].classList.remove('hidden');
                    else headers[index].classList.add('hidden');
                } else if (selectedCrop === 'group_rc') {
                    if (['rice', 'corn'].includes(key)) headers[index].classList.remove('hidden');
                    else headers[index].classList.add('hidden');
                } else if (selectedCrop !== 'all' && key !== selectedCrop) {
                    if(selectedCrop === 'veg' && key === 'vegType') { headers[index].classList.remove('hidden'); }
                    else { headers[index].classList.add('hidden'); }
                } else {
                    headers[index].classList.remove('hidden');
                }
            }
            if (['irr','rf','upland'].includes(key)) {
                if (selectedLand !== 'all' && key !== selectedLand) headers[index].classList.add('hidden');
                else headers[index].classList.remove('hidden');
            }
            if (key === 'cropDesc') {
                if (selectedCrop === 'group_rc' || (selectedCrop !== 'all' && selectedCrop !== 'group_hv' && selectedCrop !== 'others')) headers[index].classList.add('hidden');
                else headers[index].classList.remove('hidden');
            }
        });
    }

    function deleteItem(i) { 
        if(confirm("Are you sure?")) { 
            let currentDb = db;
            let dbKey = 'fims_calintaan_v3';
            if(activeSeason === 'wet') { currentDb = wetDb; dbKey = 'fims_calintaan_wet'; }
            if(activeSeason === 'ips') { currentDb = ipDb; dbKey = 'fims_calintaan_ips'; }
            currentDb.splice(i, 1); 
            localStorage.setItem(dbKey, JSON.stringify(currentDb)); 
            refreshTable(); 
            updateDashboardAnalytics(); 
        } 
    }

    // UPDATED IMPORT WITH UNDO PROTECTION
    function importFile() {
        const fileInput = document.getElementById('excelUpload');
        if (!fileInput.files[0]) return alert("Select file.");

        // Record Current State to History Stack before processing
        let snapshot = {
            season: activeSeason,
            data: []
        };
        if(activeSeason === 'dry') snapshot.data = JSON.parse(JSON.stringify(db));
        else if(activeSeason === 'wet') snapshot.data = JSON.parse(JSON.stringify(wetDb));
        else snapshot.data = JSON.parse(JSON.stringify(ipDb));
        
        dbHistory.push(snapshot);
        document.getElementById('undoBtn').classList.remove('hidden');

        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1});
            
            let currentDb = db;
            let dbKey = 'fims_calintaan_v3';
            if(activeSeason === 'wet') { currentDb = wetDb; dbKey = 'fims_calintaan_wet'; }
            if(activeSeason === 'ips') { currentDb = ipDb; dbKey = 'fims_calintaan_ips'; }

            let skipped = 0;
            json.forEach((row, index) => {
                if (index > 0 && row[1]) { 
                    let f = { fims:row[0]||'', name:row[1]||'', bday:row[2]||'', location:row[3]||'', loc:row[4]||'', geo:row[5]||'', irr:row[6]||'', rf:row[7]||'', upland:row[8]||'', rice:row[9]||'', corn:row[10]||'', onion:row[11]||'', mung:row[12]||'', veg:row[13]||'', vegType:row[14]||'', melon:row[15]||'', others:row[16]||'', cropDesc:row[17]||'', note:row[18]||'' };
                    const isDuplicate = currentDb.some(entry => 
                        (entry.name||"").trim().toLowerCase() === (f.name||"").trim().toLowerCase() && 
                        (entry.geo || "") === (f.geo || "") && 
                        (entry.location || "").trim().toLowerCase() === (f.location || "").trim().toLowerCase()
                    );
                    if (!isDuplicate) currentDb.push(f); else skipped++;
                }
            });
            localStorage.setItem(dbKey, JSON.stringify(currentDb)); 
            refreshTable(); 
            updateDashboardAnalytics();
            alert(`Import Complete. Added records while preserving previous data. Skipped ${skipped} duplicates.`);
        }; reader.readAsArrayBuffer(fileInput.files[0]);
    }

    // UNDO FUNCTION
    function undoImport() {
        if(dbHistory.length === 0) return;
        const lastState = dbHistory.pop();
        
        let dbKey = '';
        if(lastState.season === 'dry') { db = lastState.data; dbKey = 'fims_calintaan_v3'; }
        else if(lastState.season === 'wet') { wetDb = lastState.data; dbKey = 'fims_calintaan_wet'; }
        else { ipDb = lastState.data; dbKey = 'fims_calintaan_ips'; }

        localStorage.setItem(dbKey, JSON.stringify(lastState.data));
        
        if(dbHistory.length === 0) document.getElementById('undoBtn').classList.add('hidden');
        
        refreshTable();
        updateDashboardAnalytics();
        alert("Last import has been undone. Data restored to previous state.");
    }

    function exportExcel() {
        const brgy = document.getElementById('loc').value || "______________";
        let seasonText = "DRY SEASON";
        if(activeSeason === 'wet') seasonText = "WET SEASON";
        if(activeSeason === 'ips') seasonText = "IP'S";

        const lftName = document.getElementById('lftInput').value || "";
        const lftTitle = document.getElementById('lftDesignationInput').value || "Local Farmer Technician (LFT)";
        const atName = document.getElementById('atInput').value || "";
        const atTitle = document.getElementById('atDesignationInput').value || "Agricultural Technician";
        
        const headerRows = [["REPUBLIC OF THE PHILIPPINES"], ["OFFICE OF THE MUNICIPAL AGRICULTURE"], [`CALINTAAN FIMS - ${seasonText}`], [`MASTERLIST OF BARANGAY ${brgy.toUpperCase()}`], ["Municipality of Calintaan, Occidental Mindoro"], []];
        
        let cHead = ["RICE", "CORN", "ONION", "MUNG", "VEG", "VEG TYPE", "MELON", "OTHERS"];
        if(activeSeason === 'ips') cHead = ["RICE", "UBE", "GINGER", "MUNGBEAN", "TARO", "TARO VARIETY", "S.POTATO", "CHILI"];

        const tableHeader = ["FIMS #", "FULL NAME", "BIRTH DATE", "LOCATION", "BARANGAY", "GEOTAG", "IRR (Ha)", "RF (Ha)", "UPLAND (Ha)", ...cHead, "SPECIFY CROP", "NOTE"];
        
        let currentDb = db;
        if(activeSeason === 'wet') currentDb = wetDb;
        if(activeSeason === 'ips') currentDb = ipDb;

        let totals = Array(19).fill(0);
        const dataRows = currentDb.map(item => {
            const row = [item.fims, item.name, item.bday, item.location, item.loc, item.geo, parseFloat(item.irr)||0, parseFloat(item.rf)||0, parseFloat(item.upland)||0, parseFloat(item.rice)||0, parseFloat(item.corn)||0, parseFloat(item.onion)||0, parseFloat(item.mung)||0, parseFloat(item.veg)||0, item.vegType, parseFloat(item.melon)||0, parseFloat(item.others)||0, item.cropDesc, item.note];
            for(let i=5; i<=13; i++) totals[i] += parseFloat(row[i]) || 0; 
            for(let i=15; i<=16; i++) totals[i] += parseFloat(row[i]) || 0;
            return row;
        });
        const totalRow = ["GRAND TOTAL", "", "", "", "", totals[5], totals[6], totals[7], totals[8], totals[9], totals[10], totals[11], totals[12], totals[13], "", totals[15], totals[16], "", ""];
        const signatoryRows = [[], [], ["Prepared by:", "", "", "", "", "", "", "Attested by:"], [], [], [lftName.toUpperCase(), "", "", "", "", "", "", atName.toUpperCase()], [lftTitle, "", "", "", "", "", "", atTitle]];
        const finalAOE = [...headerRows, tableHeader, ...dataRows, totalRow, ...signatoryRows];
        const ws = XLSX.utils.aoa_to_sheet(finalAOE); const wb = XLSX.utils.book_new();
        ws['!merges'] = [{ s: {r: 0, c: 0}, e: {r: 0, c: 18} }, { s: {r: 1, c: 0}, e: {r: 1, c: 18} }, { s: {r: 2, c: 0}, e: {r: 2, c: 18} }, { s: {r: 3, c: 0}, e: {r: 3, c: 18} }, { s: {r: 4, c: 0}, e: {r: 4, c: 18} }];
        XLSX.utils.book_append_sheet(wb, ws, "DA_Masterlist"); XLSX.writeFile(wb, `FIMS_Calintaan_${activeSeason.toUpperCase()}_Masterlist.xlsx`);
    }

    function wipeDB() { 
        if(confirm(`Wipe all data in the ${activeSeason.toUpperCase()} database?`)) { 
            let dbKey = 'fims_calintaan_v3';
            if(activeSeason === 'wet') dbKey = 'fims_calintaan_wet';
            if(activeSeason === 'ips') dbKey = 'fims_calintaan_ips';
            localStorage.removeItem(dbKey); 
            if(activeSeason === 'dry') db = []; else if(activeSeason === 'wet') wetDb = []; else ipDb = [];
            refreshTable(); 
            updateDashboardAnalytics(); 
        } 
    }
</script>

</body>
</html>